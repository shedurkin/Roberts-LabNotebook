{
  "hash": "9aaf2914fa2081babc9097ec3ea4f09e",
  "result": {
    "markdown": "---\ntitle: \"Timeseries: Running the Elastic Net with GbM (instead of CpG methylation)\"\nauthor: \"Kathleen Durkin\"\ndate: \"2025-12-05\"\ncategories: [\"E5-coral\"]\nformat:\n  html:\n    toc: true\nexecute: \n  eval: TRUE\nengine: knitr\nbibliography: ../../../references.bib\n---\n\n\nWill be using the Elastic Net script I made a few weeks ago: `timeseries/M-multi-species/scripts/26.2-ElasticNet-scaling.R` ([link](https://github.com/urol-e5/timeseries_molecular/blob/main/M-multi-species/scripts/26.2-ElasticNet-scaling.R))\n\nTook some more time to fix different formatting problems that arose when inputting new matrices, but should be plug-and-play now!\n\nTo use, run following command (I've needed to do so in a conda environment when working in Raven):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nRscript 26.2-ElasticNet-scaling.R \\\n\"ortholog_gene_counts_path.csv\" \\\n\"miRNA_counts_path.txt\" \\\n\"lncRNA_counts_path.txt\" \\\n\"methylation_matrix_path.tsv\" \\\n\"metadata_file_path.csv\" \\\n\"output_dir_path\" \\\n\"list_samples_to_exclude\" \\   # (comma-separated string like \"s1,s2\")\n0.5 \\   # alpha value for EN model (optional, default 0.5)\n25 \\    # Num. replicates for first bootstrapping round (optional, default 50)\n50 \\    # Num. replicates for second bootstrapping round (after reducing to only well-predicted genes) (optional, default 50)\n0.5     # r^2 threshold for \"well-predicted\" genes (optional, default 0.5)\n```\n:::\n\n\nImportantly, its now set up to run on input gene sets of orthologs, which may have two \"name\" columns, one for ortholog ID and one for gene ID. IT will use the ortholog ID instead of gene ID )since some genes are included in multiple orthologs). That's why line 199 reads:\n\n`genes <- as.data.frame(read.csv(genes_file)) %>% select(-gene_id)`\n\nIf you're instead working with just genes (not orthologs), you'd want to comment out this line.\n\nNow, rerunning with new inputs: Using gene set of orthorlogs involved in biomineralization, and GbM for the WGBS predictor input\n\nOutput directories:\n\n[26.2-ElasticNet-scaling-GbM](https://github.com/urol-e5/timeseries_molecular/tree/main/M-multi-species/output/26.2-ElasticNet-scaling-GbM)\\\n[26.2-ElasticNet-scaling-GbM-noise](https://github.com/urol-e5/timeseries_molecular/tree/main/M-multi-species/output/26.2-ElasticNet-scaling-GbM-noise)\n\n## Apul\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n(r_enet_rscript) shedurkin@raven:~/timeseries_molecular/M-multi-species/scripts$ Rscript 26.2-ElasticNet-scaling.R \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/M-multi-species/output/33-biomin-pathway-counts/apul_biomin_counts.csv\" \\\n\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/10.1-format-miRNA-counts-updated/Apul_miRNA_counts_formatted_updated.txt\" \\\n\"https://gannet.fish.washington.edu/v1_web/owlshell/bu-github/timeseries_molecular/D-Apul/output/31.5-Apul-lncRNA-discovery/lncRNA_counts.clean.filtered.txt\" \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/D-Apul/output/40-Apul-Gene-Methylation/Apul-gene-methylation_75pct.tsv\" \\\n\"../../M-multi-species/data/rna_metadata.csv\" \\\n\"../output/26.2-ElasticNet-scaling-GbM\" \\\n\"ACR-225-TP1\" \\\n0.5 \\\n25 \\\n50 \\\n0.5\n```\n:::\n\n\nThen want to generate a \"fake\" predictor set of just noise. For now I'll choose to (a) use a fully randomized predictor set, instead of \"spiking\" noise into the real data, and (b) to generate the random data empirically\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_noise_empirical_safe <- function(X) {\n\n  X_noise <- apply(X, 2, function(col) {\n    sample(col, length(col), replace = TRUE)\n  })\n\n  # Ensure row/col names preserved\n  colnames(X_noise) <- colnames(X)\n  X_noise[,1] <- X[,1]\n\n  # Fix rows that become all-zero\n  zero_rows <- which(rowSums(X_noise > 0) == 0)\n  if (length(zero_rows) > 0) {\n    for (i in zero_rows) {\n      # Give the row a single small positive value\n      # Put it in a random column\n      j <- sample(seq_len(ncol(X_noise)), 1)\n      X_noise[i, j] <- 1\n    }\n  }\n\n  return(X_noise)\n}\n\nmiRNA_noise <- make_noise_empirical(miRNA)\nlncRNA_noise <- make_noise_empirical(lncRNA)\nWGBS_noise <- make_noise_empirical(WGBS)\n\nwrite.table(mirna_noise, \"./M-multi-species/output/26.2-ElasticNet-scaling-GbM-noise/mirna_empirical_noise.txt\", row.names=FALSE, sep=\"\\t\")\nwrite.table(lncrna_noise, \"./M-multi-species/output/26.2-ElasticNet-scaling-GbM-noise/lncrna_empirical_noise.txt\", row.names=FALSE, sep=\"\\t\")\nwrite.csv(wgbs_noise, \"./M-multi-species/output/26.2-ElasticNet-scaling-GbM-noise/wgbs_empirical_noise.csv\", row.names=FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.bash .cell-code}\n(r_enet_rscript) shedurkin@raven:~/timeseries_molecular/M-multi-species/scripts$ Rscript 26.2-ElasticNet-scaling.R \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/M-multi-species/output/33-biomin-pathway-counts/apul_biomin_counts.csv\" \\\n\"../output/26.2-ElasticNet-scaling-GbM-noise/mirna_empirical_noise.txt\" \\\n\"../output/26.2-ElasticNet-scaling-GbM-noise/lncrna_empirical_noise.txt\" \\\n\"../output/26.2-ElasticNet-scaling-GbM-noise/wgbs_empirical_noise.csv\" \\\n\"../../M-multi-species/data/rna_metadata.csv\" \\\n\"../output/26.2-ElasticNet-scaling-GbM-noise\" \\\n\"ACR-225-TP1\" \\\n0.5 \\\n25 \\\n50 \\\n0.5\n```\n:::\n\n\nAs with CpG site methylation, running the EN with GbM methylation as one of the predictors and empirical noise as the gene set still results in a non-functional model, confirming the EN is identifying \"real\" patterns in our data (not just noise related to large data set/multiple testing). Nice!\n\n## Peve\n\n`POR-69-TP3`) and WGBS counts (`POR-73-TP2`). Also exclude `POR-236-TP2`, which has 0 counts for all miRNA. This makes it both biologically uninformative and creates NA values during scaling. I'm also going to exclude the following samples, which have almost entirely 0 counts for miRNA, suggesting a sample processing/sequencing issue: `POR-74-TP4`, `POR-262-TP4`, `POR-262-TP3`, and `POR-69-TP2`.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n(r_enet_rscript) shedurkin@raven:~/timeseries_molecular/M-multi-species/scripts$ Rscript 26.2-ElasticNet-scaling.R \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/M-multi-species/output/33-biomin-pathway-counts/peve_biomin_counts.csv\" \\\n\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/10.1-format-miRNA-counts-updated/Peve_miRNA_counts_formatted_updated.txt\" \\\n\"https://gannet.fish.washington.edu/v1_web/owlshell/bu-github/timeseries_molecular/E-Peve/output/12-Peve-lncRNA-discovery/lncRNA_counts.clean.filtered.txt\" \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/E-Peve/output/15-Peve-Gene-Methylation/Peve-gene-methylation_75pct.tsv\" \\\n\"../../M-multi-species/data/rna_metadata.csv\" \\\n\"../output/26.2-ElasticNet-scaling-GbM\" \\\n\"POR-69-TP2,POR-69-TP3,POR-73-TP2,POR-74-TP4,POR-236-TP2,POR-262-TP4,POR-262-TP3\" \\\n0.5 \\\n25 \\\n50 \\\n0.5\n```\n:::\n\n\n## Ptuh\n\nExclude: \"POC-201-TP3,POC-222-TP2,POC-255-TP4,POC-259-TP3,POC-259-TP4,POC-42-TP1,POC-42-TP3\"\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n(r_enet_rscript) shedurkin@raven:~/timeseries_molecular/M-multi-species/scripts$ Rscript 26.2-ElasticNet-scaling.R \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/M-multi-species/output/33-biomin-pathway-counts/ptua_biomin_counts.csv\" \\\n\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/10.1-format-miRNA-counts-updated/Ptuh_miRNA_counts_formatted_updated.txt\" \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries_molecular/refs/heads/main/F-Ptua/output/06-Ptua-lncRNA-discovery/lncRNA_counts.clean.filtered.txt\" \\\n\"https://raw.githubusercontent.com/urol-e5/timeseries-molecular-calcification/refs/heads/main/F-Ptua/output/09-Ptua-Gene-Methylation/Ptua-gene-methylation_75pct.tsv\" \\\n\"../../M-multi-species/data/rna_metadata.csv\" \\\n\"../output/26.2-ElasticNet-scaling-GbM\" \\\n\"POC-201-TP3,POC-222-TP2,POC-255-TP4,POC-259-TP3,POC-259-TP4,POC-42-TP1,POC-42-TP3\" \\\n0.5 \\\n25 \\\n50 \\\n0.5\n```\n:::\n\n\n## Plotting\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'dplyr' was built under R version 4.2.3\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(tidyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'tidyr' was built under R version 4.2.3\n```\n:::\n\n```{.r .cell-code}\nlibrary(purrr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_ACR <- read.csv(\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/26.2-ElasticNet-scaling-GbM/Apul_top_predictors.csv\", header=TRUE)\ndf_POR <- read.csv(\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/26.2-ElasticNet-scaling-GbM/Peve_top_predictors.csv\", header=TRUE)\ndf_POC <- read.csv(\"https://github.com/urol-e5/timeseries_molecular/raw/refs/heads/main/M-multi-species/output/26.2-ElasticNet-scaling-GbM/Ptuh_top_predictors.csv\", header=TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_topN <- function(df, N, species_name) {\n  df %>%\n    group_by(Feature) %>%\n    slice_max(order_by = MeanImportance, n = N, with_ties = FALSE) %>%\n    mutate(Species = species_name)\n}\n\ntopN <- bind_rows(\n  get_topN(df_ACR, N = 10, species_name = \"ACR\"),\n  get_topN(df_POR, N = 10, species_name = \"POR\"),\n  get_topN(df_POC, N = 10, species_name = \"POC\")\n)\n\nspecies_prop <- topN %>%\n  group_by(Species, Type) %>%\n  summarize(n = n(), .groups=\"drop\") %>%\n  group_by(Species) %>%\n  mutate(prop = n / sum(n))\n\nggplot(species_prop, aes(x = Species, y = prop, fill = Type)) +\n  geom_col() +\n  theme_minimal() +\n  labs(title = \"Proportion of predictor types (top N per OG)\",\n       y = \"Proportion\")\n```\n\n::: {.cell-output-display}\n![](2025_12_05_timeseries_EN_GbM_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "2025_12_05_timeseries_EN_GbM_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}